<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Store Management - Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-primary text-primary">
    <div class="sidebar" id="sidebar">
        <div class="p-6 border-b border-color">
            <h2 class="text-xl font-bold">Admin Panel</h2>
        </div>
        <nav class="py-4">
            <a href="/admin-dashboard.html" class="sidebar-item">
                <i class="fas fa-home w-5"></i>
                <span>Dashboard</span>
            </a>
            <a href="/admin-users.html" class="sidebar-item">
                <i class="fas fa-users w-5"></i>
                <span>Users</span>
            </a>
            <a href="/admin-store.html" class="sidebar-item active">
                <i class="fas fa-store w-5"></i>
                <span>Store Management</span>
            </a>
            <a href="/admin-settings.html" class="sidebar-item">
                <i class="fas fa-cog w-5"></i>
                <span>Settings</span>
            </a>
            <a href="/admin-logs.html" class="sidebar-item">
                <i class="fas fa-file-alt w-5"></i>
                <span>Logs</span>
            </a>
            <a href="#" onclick="logout(); return false;" class="sidebar-item">
                <i class="fas fa-sign-out-alt w-5"></i>
                <span>Logout</span>
            </a>
        </nav>
    </div>

    <div class="main-content">
        <div class="flex items-center justify-between mb-8">
            <h1 class="text-3xl font-bold">Store Management</h1>
            <button onclick="openProductModal()" class="btn btn-primary">
                <i class="fas fa-plus"></i>
                Add Product
            </button>
        </div>

        <!-- Filters -->
        <div class="card mb-6">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label class="form-label">Category</label>
                    <select id="category-filter" class="form-input">
                        <option value="">All Categories</option>
                        <option value="game_accounts">Game Accounts</option>
                        <option value="products">Products</option>
                        <option value="gift_cards">Gift Cards</option>
                        <option value="software">Software</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div>
                    <label class="form-label">Status</label>
                    <select id="status-filter" class="form-input">
                        <option value="">All Status</option>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                        <option value="out_of_stock">Out of Stock</option>
                    </select>
                </div>
                <div>
                    <label class="form-label">Search</label>
                    <input type="text" id="search-input" class="form-input" placeholder="Search products...">
                </div>
                <div class="flex items-end">
                    <button onclick="loadProducts()" class="btn btn-primary w-full">
                        <i class="fas fa-search"></i>
                        Filter
                    </button>
                </div>
            </div>
        </div>

        <!-- Products Table -->
        <div class="card">
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Image</th>
                            <th>Name</th>
                            <th>Category</th>
                            <th>Price</th>
                            <th>Stock</th>
                            <th>Status</th>
                            <th>Sales</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="products-tbody">
                        <tr>
                            <td colspan="9" class="text-center text-secondary">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div id="pagination" class="mt-6 flex justify-center gap-2"></div>
        </div>
    </div>

    <!-- Product Modal -->
    <div id="product-modal" class="modal-overlay hidden">
        <div class="modal" style="max-width: 700px;">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold" id="modal-title">Add Product</h2>
                <button onclick="closeProductModal()" class="text-secondary hover:text-primary">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            <form id="product-form" class="space-y-4">
                <input type="hidden" id="product-id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="form-label">Product Name *</label>
                        <input type="text" id="product-name" class="form-input" required>
                    </div>
                    <div>
                        <label class="form-label">Category *</label>
                        <select id="product-category" class="form-input" required>
                            <option value="">Select Category</option>
                            <option value="game_accounts">Game Accounts</option>
                            <option value="products">Products</option>
                            <option value="gift_cards">Gift Cards</option>
                            <option value="software">Software</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="form-label">Description</label>
                    <textarea id="product-description" class="form-input" rows="3"></textarea>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="form-label">Price *</label>
                        <input type="number" id="product-price" class="form-input" required min="0" step="0.01">
                    </div>
                    <div>
                        <label class="form-label">Stock</label>
                        <input type="number" id="product-stock" class="form-input" min="0" placeholder="Leave empty for unlimited">
                    </div>
                    <div>
                        <label class="form-label">Status</label>
                        <select id="product-status" class="form-input">
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="form-label">Image URL</label>
                    <input type="url" id="product-image" class="form-input" placeholder="https://example.com/image.jpg">
                </div>
                <div>
                    <label class="form-label">Product Details</label>
                    <textarea id="product-details" class="form-input" rows="5" placeholder="Additional details, credentials, etc. (one per line)"></textarea>
                    <p class="text-xs text-secondary mt-1">For game accounts: username, password, email (one per line)</p>
                </div>
                <div class="flex gap-4">
                    <button type="submit" class="btn btn-primary flex-1">
                        <i class="fas fa-save"></i>
                        Save Product
                    </button>
                    <button type="button" onclick="closeProductModal()" class="btn btn-secondary">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script src="/js/utils.js"></script>
    <script src="/js/auth.js"></script>
    <script src="/js/common.js"></script>
    <script>
        let products = [];
        let currentPage = 1;

        function getCategoryBadgeClass(category) {
            const categoryMap = {
                'game_accounts': 'badge-info',
                'products': 'badge-success',
                'gift_cards': 'badge-warning',
                'software': 'badge-primary',
                'other': 'badge-secondary'
            };
            return categoryMap[category] || 'badge-secondary';
        }

        function formatCategory(category) {
            return category.split('_').map(word => 
                word.charAt(0).toUpperCase() + word.slice(1)
            ).join(' ');
        }

        // Mock products for admin
        const mockAdminProducts = [
            { id: 1, name: "Fortnite Account - Level 200", category: "game_accounts", price: 89.99, stock: 5, status: "active", sales_count: 12, image: "https://images.unsplash.com/photo-1542751371-adc38448a05e?w=400" },
            { id: 2, name: "PlayStation 5 Digital Edition", category: "products", price: 399.99, stock: 3, status: "active", sales_count: 8, image: "https://images.unsplash.com/photo-1606813907291-d86efa9b94db?w=400" },
            { id: 3, name: "Steam Gift Card $50", category: "gift_cards", price: 50.00, stock: 20, status: "active", sales_count: 45, image: "https://images.unsplash.com/photo-1556742049-0cfed4f6a45d?w=400" },
            { id: 4, name: "Call of Duty: Modern Warfare Account", category: "game_accounts", price: 149.99, stock: 2, status: "active", sales_count: 5, image: "https://images.unsplash.com/photo-1552820728-8b83bb6b773f?w=400" },
            { id: 5, name: "Adobe Creative Cloud License", category: "software", price: 599.99, stock: 10, status: "active", sales_count: 3, image: "https://images.unsplash.com/photo-1611162617474-5b21e879e113?w=400" },
            { id: 6, name: "Xbox Game Pass Ultimate 12 Months", category: "gift_cards", price: 179.99, stock: 15, status: "active", sales_count: 22, image: "https://images.unsplash.com/photo-1606144042614-b2417e99c4e3?w=400" }
        ];

        async function loadProducts(page = 1) {
            currentPage = page;
            const category = document.getElementById('category-filter').value;
            const status = document.getElementById('status-filter').value;
            const search = document.getElementById('search-input').value;

            try {
                let url = `/api/admin/store/products?page=${page}&limit=20`;
                if (category) url += `&category=${category}`;
                if (status) url += `&status=${status}`;
                if (search) url += `&search=${encodeURIComponent(search)}`;

                const response = await apiRequest(url);
                if (response && response.success) {
                    products = response.products;
                    renderProducts();

                    // Pagination
                    if (response.pagination) {
                        renderPagination(response.pagination);
                    }
                } else {
                    // Use mock data
                    let filteredProducts = [...mockAdminProducts];
                    if (category) {
                        filteredProducts = filteredProducts.filter(p => p.category === category);
                    }
                    if (status) {
                        filteredProducts = filteredProducts.filter(p => p.status === status);
                    }
                    if (search) {
                        const searchLower = search.toLowerCase();
                        filteredProducts = filteredProducts.filter(p => 
                            p.name.toLowerCase().includes(searchLower)
                        );
                    }
                    products = filteredProducts;
                    renderProducts();
                }
            } catch (error) {
                console.error('Error loading products:', error);
                // Use mock data
                let filteredProducts = [...mockAdminProducts];
                const category = document.getElementById('category-filter').value;
                const status = document.getElementById('status-filter').value;
                const search = document.getElementById('search-input').value;
                if (category) {
                    filteredProducts = filteredProducts.filter(p => p.category === category);
                }
                if (status) {
                    filteredProducts = filteredProducts.filter(p => p.status === status);
                }
                if (search) {
                    const searchLower = search.toLowerCase();
                    filteredProducts = filteredProducts.filter(p => 
                        p.name.toLowerCase().includes(searchLower)
                    );
                }
                products = filteredProducts;
                renderProducts();
            }
        }

        function renderProducts() {
            const tbody = document.getElementById('products-tbody');
            
            if (products.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center text-secondary">No products found</td></tr>';
                return;
            }

            tbody.innerHTML = products.map(product => `
                <tr>
                    <td>#${product.id}</td>
                    <td>
                        ${product.image ? `
                            <img src="${product.image}" alt="${product.name}" class="w-16 h-16 object-cover rounded">
                        ` : `
                            <div class="w-16 h-16 bg-tertiary rounded flex items-center justify-center">
                                <i class="fas fa-image text-secondary"></i>
                            </div>
                        `}
                    </td>
                    <td>
                        <div class="font-semibold">${product.name}</div>
                        <div class="text-xs text-secondary line-clamp-1">${product.description || ''}</div>
                    </td>
                    <td>
                        <span class="badge ${getCategoryBadgeClass(product.category)}">
                            ${formatCategory(product.category)}
                        </span>
                    </td>
                    <td><strong>${formatCurrency(product.price)}</strong></td>
                    <td>
                        ${product.stock !== null ? product.stock : '<span class="text-secondary">âˆž</span>'}
                    </td>
                    <td>
                        <span class="badge ${product.status === 'active' ? 'badge-success' : 'badge-pending'}">
                            ${product.status === 'active' ? 'Active' : 'Inactive'}
                        </span>
                    </td>
                    <td>${product.sales_count || 0}</td>
                    <td>
                        <div class="flex gap-2">
                            <button onclick="editProduct(${product.id})" class="btn btn-secondary btn-sm">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteProduct(${product.id})" class="btn btn-danger btn-sm">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function renderPagination(pagination) {
            const paginationEl = document.getElementById('pagination');
            let paginationHTML = '';

            if (pagination.page > 1) {
                paginationHTML += `<button onclick="loadProducts(${pagination.page - 1})" class="btn btn-secondary">Previous</button>`;
            }

            paginationHTML += `<span class="px-4 py-2">Page ${pagination.page} of ${pagination.pages}</span>`;

            if (pagination.page < pagination.pages) {
                paginationHTML += `<button onclick="loadProducts(${pagination.page + 1})" class="btn btn-secondary">Next</button>`;
            }

            paginationEl.innerHTML = paginationHTML;
        }

        function openProductModal() {
            document.getElementById('modal-title').textContent = 'Add Product';
            document.getElementById('product-form').reset();
            document.getElementById('product-id').value = '';
            document.getElementById('product-status').value = 'active';
            document.getElementById('product-modal').classList.remove('hidden');
        }

        function closeProductModal() {
            document.getElementById('product-modal').classList.add('hidden');
            document.getElementById('product-form').reset();
        }

        async function editProduct(productId) {
            try {
                const response = await apiRequest(`/api/admin/store/products/${productId}`);
                if (response && response.success) {
                    const product = response.product;
                    document.getElementById('modal-title').textContent = 'Edit Product';
                    document.getElementById('product-id').value = product.id;
                    document.getElementById('product-name').value = product.name;
                    document.getElementById('product-category').value = product.category;
                    document.getElementById('product-description').value = product.description || '';
                    document.getElementById('product-price').value = product.price;
                    document.getElementById('product-stock').value = product.stock || '';
                    document.getElementById('product-status').value = product.status;
                    document.getElementById('product-image').value = product.image || '';
                    document.getElementById('product-details').value = product.details || '';
                    document.getElementById('product-modal').classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error loading product:', error);
                showNotification('Failed to load product', 'error');
            }
        }

        async function deleteProduct(productId) {
            if (!confirm('Are you sure you want to delete this product?')) {
                return;
            }

            try {
                const response = await apiRequest(`/api/admin/store/products/${productId}`, {
                    method: 'DELETE'
                });

                if (response && response.success) {
                    showNotification('Product deleted successfully', 'success');
                    loadProducts(currentPage);
                }
            } catch (error) {
                showNotification(error.message || 'Failed to delete product', 'error');
            }
        }

        document.getElementById('product-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const productId = document.getElementById('product-id').value;
            const productData = {
                name: document.getElementById('product-name').value,
                category: document.getElementById('product-category').value,
                description: document.getElementById('product-description').value,
                price: parseFloat(document.getElementById('product-price').value),
                stock: document.getElementById('product-stock').value ? parseInt(document.getElementById('product-stock').value) : null,
                status: document.getElementById('product-status').value,
                image: document.getElementById('product-image').value || null,
                details: document.getElementById('product-details').value || null
            };

            try {
                let response;
                if (productId) {
                    // Update
                    response = await apiRequest(`/api/admin/store/products/${productId}`, {
                        method: 'PUT',
                        body: JSON.stringify(productData)
                    });
                } else {
                    // Create
                    response = await apiRequest('/api/admin/store/products', {
                        method: 'POST',
                        body: JSON.stringify(productData)
                    });
                }

                if (response && response.success) {
                    showNotification(productId ? 'Product updated successfully' : 'Product created successfully', 'success');
                    closeProductModal();
                    loadProducts(currentPage);
                }
            } catch (error) {
                showNotification(error.message || 'Failed to save product', 'error');
            }
        });

        // Search debounced
        document.getElementById('search-input').addEventListener('input', debounce(() => {
            loadProducts(1);
        }, 500));

        window.addEventListener('DOMContentLoaded', () => {
            loadProducts();
        });
    </script>
</body>
</html>

